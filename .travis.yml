dist: bionic
language: go

services:
  - docker

go:
  - 1.14.x
  - tip

matrix:
  allow_failures:
    - go: tip

env:
  global:
    secure: "o1dj6eNebK5Nf8xk9Dxi5d9+t50HlQrbHCKocjHJueCBsVTCV1pVCQYBtgW5hkgWAb/ZJwQl8TZtH5SHomMLMAJqZx/k8hubYaBsAKBNWTAlj4J/wWivIMPSKEsl59ldspoWhTqI5JUXoSCgy8etMq5adaR0zBLxoLDnhc5kcWte//brdzaZCmzpCIN6zHxIKrsxvKmXb6gy1uZcVkSThnDEKNXVfet86XPx7wZNuHBca3eB0z1Z+SFj+U0iZqNN0jdUmIWzsy8VwI8AWK0MKgarKjyvqetK3sO2RN3tSbPsVGceIDXTfU9ktCqrSlpPBn6S5N6bMtFbdNZeHZntXvtPNvqB9FGH0s69u2K8MHNg2031arVNwYr+AWEfv4DB7nQbo4fCtvnQ4fhVXdkK+I+bJjNUcVctZt+4ejH07+nqjZAYub1ZYY8Lj27OTEmRrHGVA/NeknSrGYXqGXifBfh9AqnKIZh3zrA8+p6d//uNL4zdqGfgQvMlL54qyTvvR7TbWFW/MkFOTKQ0u9+CodMQ7Sg2IkmaLM4R6kTX904uPq8mGebpHK8FWMHy8tommOIzBPcPTISv7HWPdmUE8vzybL98sijkfWd4CoWNg3Lr/UO16Q4LyD9srpUODBJfWl8OHcD9j0zXejVhJdOaj7Euekk5/kdz7p6e7ck/PXk="

branches:
  except:
    - /^PMM\-\d{4}/

go_import_path: github.com/percona/qan-api2

cache:
  directories:
    - /home/travis/.cache/go-build
    # - /home/travis/gopath/pkg

before_cache:
  - go clean -testcache
  # - go clean -cache

install:
  # ensure that vendor/ is in sync with code and Gopkg.toml/lock
  - curl https://raw.githubusercontent.com/golang/dep/master/install.sh | sh
  - dep check
  # install reviewdog and golangci-lin
  - curl https://raw.githubusercontent.com/reviewdog/reviewdog/master/install.sh| sh -s

before_script:
  # ensure that generated files are not changed
  - make init
  - make gen
  - make format
  - git status
  - git diff --exit-code

script:
  # static analyze
  - make ci-reviewdog

  - make install
  - make test-env-up
  - make test-race
  - make test-cover

  - make check

after_success:
  - bash <(curl -s https://codecov.io/bash) -X fix

notifications:
  slack:
    on_success: change
    on_failure: always
    rooms:
      # REVIEWDOG_GITHUB_API_TOKEN
      secure: "HcCvViqiXLMV7S7NJOwA7k5Aoj0ukPdhKs4uzfq7r+aK9rKPtjNLnaMs7fPW+5tKw1ctECCyPsjIJpvv8uePvKULLDJ+a5aWvXudqGvIbHKUOo1SfUSZ8W45HG9zBLIs5GfeRvT7TKiFK8F++3UqrJUI4Fle4K1ao4kr2BsEDuJ2qMb01MskVfF+O/dgxSzAOq2uPdQ2Zj8wVDYoRFKFIt1JTx0yB18qIS5HBvwLncTUrxftgbg29DDGzU/BH6NQlJAdXXkdoT6i4bXGkDQwFcSTPQAA0CEixW7f/AhZnvS58kAyEftZDNMKdYScblul0xZenPNLXqrWSZIrJxgqcY8id1z9/MFRR2AJ2xFb+4d/0+gulHcWB1/pGbZvkaCW45WVcypfDzTN4htbsoGFLhOkUxsjkUCfP3aYsBGpmPkaXjmH88zOpzsbmZLWcjptQn2960CTGKqb0PV8CDOZETEazacIbP9LHLrky7Mpvph/dBlwv+44549rqDh1vfIJyWLkXrKgqbpaR6HZsg9KA8dNnijnP1iVoda8vsmOZ44mUEQrnR3+8CUG0ngKsfvWd/99Jdnf/aL8GjQ6DOOlBrJahkLVt3PWBbN6HgR2g3D3dm0OGV2JzfpIZPYkeghdcMHwKSzcC+O115vYSNwnPS98+b/uWehiU7ejwdbSyZA="
